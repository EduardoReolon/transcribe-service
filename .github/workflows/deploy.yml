name: Deploy Whisper Service
on:
  push:
    branches:
      - main
jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      SERVER_TARGET_PATH: /home/ubuntu/transcribe-service
      SYSTEMCTL_SERVICES: "whisper" # Nome que definimos para o systemctl

    steps:
      - uses: actions/checkout@v3

      - name: Clean unnecessary files
        run: |
          rm -rf venv/
          rm -rf .git/
          rm -rf storage/
          echo "Limpeza pré-deploy concluída (não enviando storage/ ou venv/)."

      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          source: "."
          target: ${{ env.SERVER_TARGET_PATH }}
          rm: false

      - name: Run remote commands
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            # 1. Instalação de dependências (Python 3.10 e Compilação ARM)
            sudo apt-get update

            TARGET_PATH=${{ env.SERVER_TARGET_PATH }}
            cd $TARGET_PATH

            # 2. Setup do Venv com Python 3.10
            if [ ! -d "venv" ]; then
              sudo apt-get install -y python3.10-dev libpython3.10-dev cmake build-essential
              python3.10 -m venv venv
            fi
            source venv/bin/activate

            # 3. Lógica de Requisitos Flexíveis
            NEW_REQ_HASH=$(sha256sum requirements.txt | awk '{ print $1 }')
            OLD_REQ_HASH_FILE=".requirements_hash"

            if [ "$NEW_REQ_HASH" != "$(cat $OLD_REQ_HASH_FILE 2>/dev/null)" ]; then
              echo "Dependências mudaram. Instalando..."
              pip install --upgrade pip setuptools wheel
              
              if [ -f "convert_requirements.py" ]; then
                python convert_requirements.py

                # Força o CMake a aceitar a política antiga
                export CMAKE_ARGS="-DCMAKE_POLICY_VERSION_MINIMUM=3.5"
                
                pip install -r requirements_flexible.txt -c constraints.txt
              else
                pip install -r requirements.txt
              fi
              
              echo "$NEW_REQ_HASH" > $OLD_REQ_HASH_FILE
            fi

            # 4. Garante diretórios necessários
            mkdir -p storage logs

            # 5. Reinicialização de Serviços em Loop
            for service in ${{ env.SYSTEMCTL_SERVICES }}; do
              echo "Restarting: $service"
              sudo systemctl restart $service --no-block
            done