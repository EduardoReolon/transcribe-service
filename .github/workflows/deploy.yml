name: Deploy Whisper Service
on:
  push:
    branches:
      - main
jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      SERVER_TARGET_PATH: /home/ubuntu/transcribe-service
      SYSTEMCTL_SERVICES: "whisper" # Nome que definimos para o systemctl

    steps:
      - uses: actions/checkout@v3

      - name: Clean unnecessary files
        run: |
          rm -rf venv/
          rm -rf .git/
          rm -rf storage/
          echo "Limpeza pré-deploy concluída (não enviando storage/ ou venv/)."

      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          source: "."
          target: ${{ env.SERVER_TARGET_PATH }}
          rm: false

      - name: Run remote commands
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            # 1. Instalação de dependências de compilação (necessário para o Whisper ARM)
            sudo apt-get update
            sudo apt-get install -y python3-pip cmake build-essential

            TARGET_PATH=${{ env.SERVER_TARGET_PATH }}
            cd $TARGET_PATH

            # 2. Setup do Venv
            if [ ! -d "venv" ]; then
              python3 -m venv venv
            fi
            source venv/bin/activate

            # 3. Lógica de Requisitos Flexíveis (Seu padrão)
            NEW_REQ_HASH=$(sha256sum requirements.txt | awk '{ print $1 }')
            OLD_REQ_HASH_FILE=".requirements_hash"

            if [ "$NEW_REQ_HASH" != "$(cat $OLD_REQ_HASH_FILE 2>/dev/null)" ]; then
              echo "Dependências mudaram. Instalando..."
              pip install --upgrade pip setuptools wheel
              
              # Executa seu script de conversão
              if [ -f "convert_requirements.py" ]; then
                python convert_requirements.py
                pip install -r requirements_flexible.txt
              else
                pip install -r requirements.txt
              fi
              
              echo "$NEW_REQ_HASH" > $OLD_REQ_HASH_FILE
            fi

            # 4. Garante que a pasta storage existe para o modelo
            mkdir -p storage

            # 5. Restart do Serviço
            echo "Reiniciando serviço: ${{ env.SYSTEMCTL_SERVICES }}"
            sudo systemctl restart ${{ env.SYSTEMCTL_SERVICES }}